<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quranic Recitation Player</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Quran Player">
    <link rel="apple-touch-icon" href="quran-icon.png">
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --primary-color: #1d3557;
            --secondary-color: #457b9d;
            --accent-color: #a8dadc;
            --background-color: #f1faee;
            --surface-color: #ffffff;
            --danger-color: #e63946;
            --muted-color: #6c757d;
            --text-color: #1f2933;
            --border-radius: 12px;
            --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.15);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, -webkit-system-font, sans-serif;
            background-color: #0f172a;
            background-image: radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.15) 0, transparent 40%), radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.12) 0, transparent 45%);
            color: #e5e7eb;
            min-height: 100vh;
            padding: 16px;
        }

        .app-container {
            max-width: 980px;
            margin: 0 auto;
            background: radial-gradient(circle at top left, rgba(59,130,246,0.18), transparent 55%), #020617;
            border-radius: 24px;
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(148,163,184,0.25);
            padding: 18px;
            position: relative;
            overflow: hidden;
        }

        .app-container::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top right, rgba(45,212,191,0.16), transparent 55%);
            opacity: 0.9;
            pointer-events: none;
        }

        .app-inner { position: relative; z-index: 1; }

        header {
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(148,163,184,0.35);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .title-group { display: flex; align-items: center; gap: 10px; }

        .app-icon {
            width: 38px;
            height: 38px;
            border-radius: 12px;
            background: radial-gradient(circle at 30% 30%, #22c55e, #065f46);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ecfdf5;
            font-size: 20px;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5);
            border: 1px solid rgba(16, 185, 129, 0.4);
        }

        h1 { font-size: 20px; margin: 0; color: #e5e7eb; letter-spacing: 0.02em; }
        .subtitle { margin: 2px 0 0; font-size: 12px; color: #9ca3af; }

        .badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 4px 9px; border-radius: 999px;
            background-color: rgba(15,23,42,0.8);
            border: 1px solid rgba(148,163,184,0.6);
            color: #e5e7eb; font-size: 11px; white-space: nowrap;
        }
        .badge-dot { width: 6px; height: 6px; border-radius: 999px; background-color: #22c55e; box-shadow: 0 0 0 3px rgba(34,197,94,0.35); }

        .tabs {
            display: flex; margin-bottom: 16px; padding: 3px;
            background-color: rgba(15,23,42,0.9);
            border-radius: 999px; border: 1px solid rgba(31,41,55,0.9);
        }

        .tab {
            flex: 1; padding: 8px 10px; text-align: center; border-radius: 999px;
            cursor: pointer; font-size: 13px; font-weight: 500; color: #9ca3af;
            border: none; background: transparent;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            transition: all 0.17s ease;
        }
        .tab.active {
            background: radial-gradient(circle at 20% 0, rgba(59,130,246,0.45), rgba(37,99,235,0.95));
            color: #f9fafb;
            box-shadow: 0 7px 18px rgba(37,99,235,0.55);
        }
        .tab span.icon { font-size: 15px; }

        .tab-content {
            display: none; border-radius: 18px;
            background-color: rgba(15,23,42,0.9);
            border: 1px solid rgba(31,41,55,0.9);
            padding: 14px; margin-bottom: 14px;
            backdrop-filter: blur(20px);
        }
        .tab-content.active { display: block; }

        .section-title { font-size: 14px; margin: 0 0 8px; color: #e5e7eb; display: flex; align-items: center; gap: 6px; }
        .section-title small { font-size: 11px; color: #9ca3af; font-weight: 400; }
        .section-icon { font-size: 16px; }

        .grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .app-container { padding: 14px; }
        }

        .form-group { margin-bottom: 10px; }
        label { display: block; margin-bottom: 4px; font-size: 11px; color: #9ca3af; font-weight: 500; letter-spacing: 0.03em; text-transform: uppercase; }

        input[type="text"], input[type="number"], select {
            width: 100%; padding: 7px 9px; border-radius: 9px;
            border: 1px solid rgba(55,65,81,0.95);
            background-color: rgba(15,23,42,0.95); color: #e5e7eb; font-size: 13px;
            outline: none; transition: all 0.15s ease;
        }
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            border-color: rgba(59,130,246,0.9); box-shadow: 0 0 0 1px rgba(59,130,246,0.5);
        }

        input[type="file"] { display: none; }
        .file-input-label {
            display: block; padding: 12px; background-color: var(--secondary-color);
            color: white; border-radius: 6px; text-align: center; cursor: pointer;
            font-weight: 500; transition: all 0.3s ease;
        }
        .file-input-label:hover { background-color: var(--primary-color); }

        .file-list-preview {
            margin-top: 10px; padding: 10px;
            border: 1px dashed var(--accent-color);
            border-radius: 6px; max-height: 100px; overflow-y: auto;
        }

        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 8px 12px; border-radius: 999px; border: none;
            cursor: pointer; font-weight: 500; font-size: 13px;
            transition: all 0.2s ease; gap: 6px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #10b981); color: white;
            box-shadow: 0 8px 20px rgba(59,130,246,0.4);
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 24px rgba(59,130,246,0.55);
            filter: brightness(1.03);
        }
        .btn-secondary {
            background-color: rgba(15,23,42,0.95); color: #e5e7eb;
            border: 1px solid rgba(55,65,81,0.9);
        }
        .btn-secondary:hover { background-color: rgba(31,41,55,0.95); }

        .btn-danger {
            background-color: rgba(220, 38, 38, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(220, 38, 38, 0.5);
        }
        .btn-danger:hover {
            background-color: rgba(220, 38, 38, 0.35);
        }

        .btn-icon {
            width: 32px; height: 32px; border-radius: 999px;
            background-color: rgba(15,23,42,0.95);
            border: 1px solid rgba(55,65,81,0.9);
            display: flex; align-items: center; justify-content: center;
            color: #e5e7eb; cursor: pointer; transition: all 0.15s ease; font-size: 14px;
        }
        .btn-icon:hover:not(:disabled) {
            background-color: rgba(31,41,55,0.95); transform: translateY(-1px);
        }
        .btn-icon:disabled { opacity: 0.4; cursor: default; }

        /* Settings cards */
        .settings-row {
            display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 10px; margin-top: 8px;
        }
        @media (max-width: 768px) { .settings-row { grid-template-columns: 1fr; } }

        .setting-box {
            border-radius: 12px; border: 1px solid rgba(55,65,81,0.95);
            padding: 10px; background: radial-gradient(circle at top left, rgba(59,130,246,0.12), transparent 55%);
        }
        .setting-box h3 { margin: 0 0 6px; font-size: 13px; color: #e5e7eb; }

        /* Playlist and player */
        .player-section {
            display: grid; grid-template-columns: minmax(0, 36%) minmax(0, 64%); gap: 12px;
        }
        @media (max-width: 768px) { .player-section { grid-template-columns: 1fr; } }

        .player-card {
            border-radius: 16px; border: 1px solid rgba(55,65,81,0.9);
            background: radial-gradient(circle at top left, rgba(59,130,246,0.18), transparent 55%), rgba(15,23,42,0.95);
            padding: 12px; box-shadow: 0 12px 28px rgba(15,23,42,0.65);
        }
        .player-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 8px;
        }
        .player-title { font-size: 13px; margin: 0; color: #e5e7eb; }
        .now-playing { font-size: 12px; color: #e5e7eb; margin: 5px 0; line-height: 1.5; }
        .playback-info { font-size: 11px; color: #9ca3af; margin: 4px 0 0; }

        .progress-bar-container {
            width: 100%; height: 4px; border-radius: 999px;
            background-color: rgba(31,41,55,0.9); margin: 8px 0 10px; overflow: hidden;
        }
        .progress-bar { width: 0; height: 100%; background: linear-gradient(90deg, #22c55e, #eab308); transition: width 0.15s linear; }

        .player-controls { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-top: 4px; }
        .transport-controls { display: flex; gap: 6px; align-items: center; }
        .playlist-meta { display: flex; align-items: center; gap: 6px; font-size: 11px; color: #9ca3af; }

        .pill {
            border-radius: 999px; background-color: rgba(15,23,42,0.95);
            border: 1px solid rgba(55,65,81,0.9); padding: 4px 8px;
            font-size: 11px; display: inline-flex; align-items: center; gap: 4px;
        }
        .pill-dot { width: 5px; height: 5px; border-radius: 999px; background-color: #22c55e; }

        .playlist-card {
            border-radius: 16px; border: 1px solid rgba(55,65,81,0.9);
            background-color: rgba(15,23,42,0.95); padding: 10px;
            max-height: 270px; overflow: hidden; display: flex; flex-direction: column; gap: 6px;
        }
        .playlist-card-header { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
        .playlist-title { font-size: 13px; margin: 0; color: #e5e7eb; }
        .playlist-count { font-size: 11px; color: #9ca3af; }
        .playlist-actions { display: flex; gap: 6px; }

        .playlist-list {
            margin: 4px 0 0; padding: 0; list-style: none; overflow-y: auto;
            border-radius: 10px; border: 1px solid rgba(31,41,55,0.9);
            background: radial-gradient(circle at top left, rgba(30,64,175,0.25), transparent 55%), rgba(15,23,42,0.9);
            flex: 1;
        }

        .file-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 7px 9px; font-size: 12px; border-bottom: 1px solid rgba(31,41,55,0.9);
            cursor: pointer; transition: all 0.15s ease;
        }
        .file-item:hover { background-color: rgba(31,41,55,0.95); }
        .file-item.active {
            background: linear-gradient(90deg, rgba(56,189,248,0.25), rgba(22,163,74,0.35));
            border-left: 2px solid #22c55e;
        }

        .file-main { display: flex; flex-direction: column; gap: 2px; flex: 1; }
        .file-title { font-weight: 500; color: #e5e7eb; }
        .file-meta { font-size: 11px; color: #9ca3af; }
        .file-index { font-size: 11px; color: #9ca3af; margin-right: 6px; min-width: 20px; }

        .delete-btn {
            background: transparent; border: none; font-size: 14px;
            cursor: pointer; padding: 4px; margin-left: 8px;
            opacity: 0.6; transition: opacity 0.2s;
        }
        .delete-btn:hover { opacity: 1; transform: scale(1.1); }

        /* Reciter Organization */
        .reciter-section { margin-bottom: 20px; }
        .reciter-header { padding: 12px; background-color: var(--light-color); border-radius: 6px; font-weight: 500; margin-bottom: 10px; cursor: pointer; }
        .reciter-content { padding-left: 15px; }

        /* Alerts */
        .alert { padding: 12px 15px; border-radius: 6px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .alert-info { background-color: var(--accent-color); color: var(--primary-color); }
        .alert-success { background-color: #d1fae5; color: #047857; }
        .alert-warning { background-color: #fef9c3; color: #854d0e; }
        .alert-icon { font-size: 16px; }

        .storage-zone {
            margin-top: 20px; padding-top: 20px;
            border-top: 1px solid rgba(148,163,184,0.3);
        }

        #installBanner {
            position: fixed; bottom: 16px; left: 50%;
            transform: translateX(-50%) translateY(160%);
            background-color: #020617; color: #e5e7eb;
            border-radius: 999px; padding: 10px 16px;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 18px 45px rgba(15,23,42,0.85);
            border: 1px solid rgba(148,163,184,0.6);
            z-index: 50; max-width: 95vw; font-size: 12px;
            transition: transform 0.25s ease-out;
        }
        #installBanner.show { transform: translateX(-50%) translateY(0); }
        #installBanner button {
            font-size: 11px; padding: 5px 9px; border-radius: 999px;
            border: none; background-color: rgba(15,23,42,0.95);
            color: #e5e7eb; cursor: pointer; display: inline-flex;
            align-items: center; gap: 4px; border: 1px solid rgba(55,65,81,0.9);
        }
        #installBanner button:hover { background-color: rgba(31,41,55,0.95); }
    </style>
</head>
<body>

<div id="installBanner">
    <span>üì± Add Quran Player to your Home Screen for a better experience.</span>
    <button id="dismissBanner">Got it</button>
</div>

<div class="app-container">
    <div class="app-inner">
        <header>
            <div class="title-group">
                <div class="app-icon">Ô∑Ω</div>
                <div>
                    <h1>Quranic Recitation Player</h1>
                    <p class="subtitle">Upload, organize, and build verse-based playlists with repeats.</p>
                </div>
            </div>
            <div class="badge">
                <span class="badge-dot"></span>
                <span>Offline-ready ¬∑ Local library</span>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" data-tab="upload">
                <span class="icon">‚¨ÜÔ∏è</span> <span>Upload & Tag</span>
            </button>
            <button class="tab" data-tab="playlist">
                <span class="icon">üéß</span> <span>Playlist & Player</span>
            </button>
            <button class="tab" data-tab="organization">
                <span class="icon">üìö</span> <span>Library</span>
            </button>
        </div>

        <div class="tab-content active" id="uploadContent">
            <h2 class="section-title">
                <span class="section-icon">üìÇ</span> Upload Audio Files
                <small>Files are stored locally in your browser (IndexedDB).</small>
            </h2>
            <div class="grid">
                <div>
                    <div class="form-group">
                        <label for="reciterName">Reciter Name</label>
                        <input type="text" id="reciterName" placeholder="e.g., Al-Afasy, Al-Husary">
                    </div>
                    <div class="form-group">
                        <label for="surahName">Surah Name</label>
                        <input type="text" id="surahName" placeholder="e.g., Al-Baqarah, Al-Fatihah">
                    </div>
                    <div class="form-group">
                        <label>Audio Files</label>
                        <label class="file-input-label">
                            <span>Choose audio files</span>
                            <input type="file" id="audioFiles" class="file-input" multiple>
                        </label>
                        <div id="fileListPreview" class="file-list-preview">
                            No files selected
                        </div>
                        <button id="uploadButton" class="btn btn-primary" style="margin-top: 10px;">
                            <span>‚ûï Add to Library</span>
                        </button>
                    </div>
                </div>
                <div>
                    <div class="alert alert-info">
                        <span class="alert-icon">‚ÑπÔ∏è</span>
                        <div>
                            <strong>Tip:</strong> Name your verse files with numbers (e.g., <code>001.mp3</code>, <code>002.mp3</code>) so the app can detect verse numbers automatically.
                        </div>
                    </div>
                    <div class="alert alert-success">
                        <span class="alert-icon">üíæ</span>
                        <div>
                            Your uploaded files are stored locally using <strong>IndexedDB</strong>.
                        </div>
                    </div>
                </div>
            </div>

            <div class="storage-zone">
                <h3 class="section-title"><span class="section-icon">üóëÔ∏è</span> Storage Management</h3>
                <p style="font-size: 12px; color: #9ca3af; margin-bottom: 10px;">
                    Use this to reduce database size or reset the application.
                </p>
                <button id="clearLibraryButton" class="btn btn-danger">
                    ‚ö†Ô∏è Clear Entire Library
                </button>
            </div>
        </div>

        <div class="tab-content" id="playlistContent">
            <h2 class="section-title">
                <span class="section-icon">üéß</span> Build Playlist
                <small>Select reciter first to see available Surahs.</small>
            </h2>

            <div class="grid">
                <div>
                    <div class="form-group">
                        <label for="reciterSelect">Reciter</label>
                        <select id="reciterSelect">
                            <option value="">All Reciters</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="surahSelect">Surah</label>
                        <select id="surahSelect">
                            <option value="">All Surahs</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Verse Range</label>
                        <div class="grid" style="grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px;">
                            <div>
                                <label for="startVerse">Start Verse:</label>
                                <input type="number" id="startVerse" min="1" value="1">
                            </div>
                            <div>
                                <label for="endVerse">End Verse:</label>
                                <input type="number" id="endVerse" min="1" value="7">
                            </div>
                        </div>
                    </div>
                    <button id="createPlaylistButton" class="btn btn-primary">Create Playlist</button>
                </div>
                <div>
                    <h3 class="section-title">
                        <span class="section-icon">üîÅ</span> Playback Settings
                    </h3>
                    <div class="settings-row">
                        <div class="setting-box">
                            <h3>Playlist Settings</h3>
                            <div class="form-group">
                                <label for="playlistRepeats">Repeat Playlist:</label>
                                <input type="number" id="playlistRepeats" min="1" value="1">
                            </div>
                        </div>
                        <div class="setting-box">
                            <h3>Verse Settings</h3>
                            <div class="form-group">
                                <label for="verseRepeats">Repeat Each Verse:</label>
                                <input type="number" id="verseRepeats" min="1" value="3">
                            </div>
                        </div>
                        <div class="setting-box">
                            <h3>Info</h3>
                            <p style="font-size: 11px; color: #9ca3af; margin: 0;">
                                The player will repeat each verse the specified number of times, then move to the next verse.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="player-section" style="margin-top: 14px;">
                <div class="player-card">
                    <div class="player-header">
                        <div>
                            <p class="player-title">Now Playing</p>
                            <p id="nowPlayingTitle" class="now-playing">No track selected</p>
                            <p id="playbackInfo" class="playback-info">‚Äî</p>
                        </div>
                        <div class="pill">
                            <span class="pill-dot"></span>
                            <span style="font-size: 11px;">Verse-repeat mode</span>
                        </div>
                    </div>
                    <div class="progress-bar-container">
                        <div id="progressBar" class="progress-bar"></div>
                    </div>
                    <div class="player-controls">
                        <div class="transport-controls">
                            <button id="prevButton" class="btn-icon" title="Previous track">‚èÆ</button>
                            <button id="playButton" class="btn-icon" title="Play/Pause">‚ñ∂</button>
                            <button id="stopButton" class="btn-icon" title="Stop" disabled>‚èπ</button>
                            <button id="nextButton" class="btn-icon" title="Next track">‚è≠</button>
                        </div>
                        <div class="playlist-meta">
                            <span class="pill">
                                <span id="playlistCount">0</span> tracks
                            </span>
                        </div>
                    </div>
                </div>

                <div class="playlist-card">
                    <div class="playlist-card-header">
                        <div>
                            <p class="playlist-title">Current Playlist</p>
                            <p class="playlist-count">Tap verse to play. Tap üóëÔ∏è to delete.</p>
                        </div>
                        <div class="playlist-actions">
                            <button id="clearPlaylistButton" class="btn-secondary btn" style="font-size: 11px; padding: 6px 10px;">
                                Clear Playlist
                            </button>
                        </div>
                    </div>
                    <ul id="playlistFiles" class="playlist-list">
                        </ul>
                </div>
            </div>
        </div>

        <div class="tab-content" id="organizationContent">
            <div class="alert alert-info">
                <span>üí°</span>
                <div>Organize your files by reciter and surah for easier playlist creation.</div>
            </div>
            <div id="recitersList">
                <p>No reciters added yet. Upload files first.</p>
            </div>
        </div>

    </div>
</div>

<script>
    const appState = {
        library: {
            files: [],
            reciters: {},
            surahs: {}
        },
        playlist: {
            files: [],
            currentIndex: 0,
            currentRepeat: 0,
            playlistRepeatCount: 0,
            totalRepeats: 1
        },
        playback: {
            isPlaying: false,
            audio: new Audio(),
            currentVerseRepeat: 0,
            totalVerseRepeats: 3
        }
    };

    // IndexedDB persistence
    let db;
    const DB_NAME = 'quran-player';
    const DB_VERSION = 1;
    const FILE_STORE = 'files';

    function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = (event) => {
                db = event.target.result;
                if (!db.objectStoreNames.contains(FILE_STORE)) {
                    const store = db.createObjectStore(FILE_STORE, { keyPath: 'id' });
                    store.createIndex('reciter', 'reciter', { unique: false });
                    store.createIndex('surah', 'surah', { unique: false });
                }
            };
            request.onsuccess = (event) => {
                db = event.target.result;
                resolve();
            };
            request.onerror = () => {
                console.error('IndexedDB error:', request.error);
                reject(request.error);
            };
        });
    }

    function saveFileToDB(fileObj) {
        return new Promise((resolve, reject) => {
            if (!db) return resolve();
            const tx = db.transaction(FILE_STORE, 'readwrite');
            const store = tx.objectStore(FILE_STORE);
            const record = {
                id: fileObj.id,
                name: fileObj.name,
                reciter: fileObj.reciter,
                surah: fileObj.surah,
                verse: fileObj.verse,
                blob: fileObj.file
            };
            store.put(record);
            tx.oncomplete = () => resolve();
            tx.onerror = () => {
                console.error('Failed to save file to DB', tx.error);
                reject(tx.error);
            };
        });
    }

    function deleteFileFromDB(id) {
        return new Promise((resolve, reject) => {
            if (!db) return resolve();
            const tx = db.transaction(FILE_STORE, 'readwrite');
            const store = tx.objectStore(FILE_STORE);
            const request = store.delete(id);
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
    }

    function clearAllFromDB() {
        return new Promise((resolve, reject) => {
            if (!db) return resolve();
            const tx = db.transaction(FILE_STORE, 'readwrite');
            const store = tx.objectStore(FILE_STORE);
            const request = store.clear();
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
    }

    function loadLibraryFromDB() {
        return new Promise((resolve, reject) => {
            if (!db) return resolve();
            const tx = db.transaction(FILE_STORE, 'readonly');
            const store = tx.objectStore(FILE_STORE);
            const request = store.getAll();

            request.onsuccess = () => {
                const records = request.result || [];
                records.forEach((rec) => {
                    const blob = rec.blob;
                    const url = URL.createObjectURL(blob);
                    const fileObj = {
                        id: rec.id,
                        file: blob,
                        url: url,
                        name: rec.name,
                        reciter: rec.reciter,
                        surah: rec.surah,
                        verse: rec.verse
                    };

                    appState.library.files.push(fileObj);

                    if (fileObj.reciter) {
                        if (!appState.library.reciters[fileObj.reciter]) {
                            appState.library.reciters[fileObj.reciter] = [];
                        }
                        appState.library.reciters[fileObj.reciter].push(fileObj);
                    }
                    if (fileObj.surah) {
                        if (!appState.library.surahs[fileObj.surah]) {
                            appState.library.surahs[fileObj.surah] = [];
                        }
                        appState.library.surahs[fileObj.surah].push(fileObj);
                    }
                });

                if (appState.library.files.length > 0) {
                    appState.playlist.files = appState.library.files.slice();
                    appState.playlist.currentIndex = 0;
                }

                updateRecitersDropdown();
                updateSurahsDropdown(); // Initialize with ALL
                updateRecitersList();
                updatePlaylistDisplay();
                resolve();
            };
            request.onerror = () => {
                console.error('Failed to load from DB', request.error);
                reject(request.error);
            };
        });
    }

    // DOM elements
    const elements = {
        tabs: document.querySelectorAll('.tab'),
        tabContents: document.querySelectorAll('.tab-content'),
        audioFilesInput: document.getElementById('audioFiles'),
        fileListPreview: document.getElementById('fileListPreview'),
        reciterNameInput: document.getElementById('reciterName'),
        surahNameInput: document.getElementById('surahName'),
        uploadButton: document.getElementById('uploadButton'),
        reciterSelect: document.getElementById('reciterSelect'),
        surahSelect: document.getElementById('surahSelect'),
        startVerseInput: document.getElementById('startVerse'),
        endVerseInput: document.getElementById('endVerse'),
        createPlaylistButton: document.getElementById('createPlaylistButton'),
        recitersList: document.getElementById('recitersList'),
        playlistRepeatsInput: document.getElementById('playlistRepeats'),
        verseRepeatsInput: document.getElementById('verseRepeats'),
        playlistFilesContainer: document.getElementById('playlistFiles'),
        clearPlaylistButton: document.getElementById('clearPlaylistButton'),
        clearLibraryButton: document.getElementById('clearLibraryButton'),
        playButton: document.getElementById('playButton'),
        stopButton: document.getElementById('stopButton'),
        prevButton: document.getElementById('prevButton'),
        nextButton: document.getElementById('nextButton'),
        progressBar: document.getElementById('progressBar'),
        nowPlayingTitle: document.getElementById('nowPlayingTitle'),
        playbackInfo: document.getElementById('playbackInfo'),
        installBanner: document.getElementById('installBanner'),
        dismissBanner: document.getElementById('dismissBanner'),
        playlistCountDisplay: document.getElementById('playlistCount')
    };

    // Utility functions
    function pad(num, size = 2) {
        let s = num + "";
        while (s.length < size) s = "0" + s;
        return s;
    }

    function formatTime(seconds) {
        if (isNaN(seconds) || seconds < 0) return "0:00";
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        return `${minutes}:${pad(remainingSeconds)}`;
    }

    function parseVerseNumber(fileName) {
        const match = fileName.match(/(\d+)/);
        return match ? parseInt(match[1], 10) : 0;
    }

    function updatePlaylistCount() {
        elements.playlistCountDisplay.textContent = appState.playlist.files.length;
    }

    // Tab logic
    elements.tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const target = tab.dataset.tab;
            elements.tabs.forEach(t => t.classList.remove('active'));
            elements.tabContents.forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(target + 'Content').classList.add('active');

            if (target === 'organization') {
                updateRecitersList();
            }
        });
    });

    // Upload & Library Logic
    let selectedFiles = [];

    elements.audioFilesInput.addEventListener('change', (event) => {
        selectedFiles = Array.from(event.target.files);
        updateFileListPreview();
    });

    function updateFileListPreview() {
        const preview = elements.fileListPreview;
        if (selectedFiles.length > 0) {
            preview.innerHTML = `<p style="margin: 0; font-weight: 500; color: #a8dadc;">${selectedFiles.length} file(s) selected:</p>`;
            const ul = document.createElement('ul');
            ul.style.listStyle = 'none';
            ul.style.padding = '0';
            ul.style.margin = '5px 0 0';
            ul.style.maxHeight = '80px';
            ul.style.overflowY = 'auto';
            selectedFiles.slice(0, 5).forEach(file => {
                const li = document.createElement('li');
                li.style.fontSize = '12px';
                li.style.color = '#e5e7eb';
                li.textContent = file.name;
                ul.appendChild(li);
            });
            if (selectedFiles.length > 5) {
                const li = document.createElement('li');
                li.style.fontSize = '12px';
                li.style.color = '#9ca3af';
                li.textContent = `... and ${selectedFiles.length - 5} more.`;
                ul.appendChild(li);
            }
            preview.appendChild(ul);
        } else {
            preview.textContent = 'No files selected';
        }
    }

    elements.uploadButton.addEventListener('click', async () => {
        const reciter = elements.reciterNameInput.value.trim();
        const surah = elements.surahNameInput.value.trim();

        if (selectedFiles.length === 0 || !reciter || !surah) {
            alert('Please select files and enter Reciter and Surah names.');
            return;
        }

        const newFiles = [];
        for (const file of selectedFiles) {
            const verse = parseVerseNumber(file.name);
            const id = Date.now() + '-' + Math.random().toString(36).substring(2, 9);
            const fileObj = {
                id,
                file: file,
                url: URL.createObjectURL(file),
                name: file.name,
                reciter: reciter,
                surah: surah,
                verse: verse
            };
            newFiles.push(fileObj);

            // Add to in-memory library
            appState.library.files.push(fileObj);
            if (!appState.library.reciters[reciter]) appState.library.reciters[reciter] = [];
            appState.library.reciters[reciter].push(fileObj);

            if (!appState.library.surahs[surah]) appState.library.surahs[surah] = [];
            appState.library.surahs[surah].push(fileObj);

            // Save to IndexedDB
            await saveFileToDB(fileObj);
        }

        // Reset inputs and update UI
        selectedFiles = [];
        elements.audioFilesInput.value = null;
        elements.reciterNameInput.value = '';
        elements.surahNameInput.value = '';
        updateFileListPreview();

        updateRecitersDropdown();
        updateSurahsDropdown();
        updateRecitersList();

        // Use the newly added files to create a default playlist/update display
        appState.playlist.files = appState.library.files.slice();
        updatePlaylistCount();
        updatePlaylistDisplay();

        alert(`Successfully added ${newFiles.length} files for ${reciter} - ${surah}!`);
    });

    elements.clearLibraryButton.addEventListener('click', async () => {
        if (!confirm('Are you absolutely sure you want to clear the entire library? This action is irreversible and will delete all stored audio files.')) {
            return;
        }
        await clearAllFromDB();
        // Reset in-memory state
        appState.library.files = [];
        appState.library.reciters = {};
        appState.library.surahs = {};
        appState.playlist.files = [];
        appState.playback.audio.pause();
        appState.playback.audio.src = '';

        updateRecitersDropdown();
        updateSurahsDropdown();
        updateRecitersList();
        updatePlaylistCount();
        updatePlaylistDisplay();
        alert('Library successfully cleared.');
    });

    // Organization & Deletion Logic
    function updateRecitersList() {
        const listContainer = elements.recitersList;
        listContainer.innerHTML = '';

        const reciters = Object.keys(appState.library.reciters).sort();
        if (reciters.length === 0) {
            listContainer.innerHTML = '<p style="color: #9ca3af;">No reciters added yet. Upload files first.</p>';
            return;
        }

        reciters.forEach(reciterName => {
            const reciterGroup = appState.library.reciters[reciterName];
            const surahs = {};
            reciterGroup.forEach(file => {
                if (!surahs[file.surah]) surahs[file.surah] = [];
                surahs[file.surah].push(file);
            });

            const reciterDiv = document.createElement('div');
            reciterDiv.className = 'reciter-section';
            reciterDiv.innerHTML = `<div class="reciter-header">${reciterName} (${reciterGroup.length} files)</div><div class="reciter-content"></div>`;

            const contentDiv = reciterDiv.querySelector('.reciter-content');

            Object.keys(surahs).sort().forEach(surahName => {
                const files = surahs[surahName].sort((a, b) => a.verse - b.verse);
                const surahList = document.createElement('ul');
                surahList.style.listStyle = 'none';
                surahList.style.padding = '0';
                surahList.style.margin = '0 0 10px 0';
                surahList.innerHTML = `<h4 style="font-size: 13px; color: #9ca3af; margin: 0 0 5px 0;">${surahName} (${files.length} verses)</h4>`;

                files.forEach(file => {
                    const listItem = document.createElement('li');
                    listItem.className = 'file-item';
                    listItem.innerHTML = `
                        <div class="file-main">
                            <span class="file-title">${file.name}</span>
                            <span class="file-meta">Verse: ${file.verse}</span>
                        </div>
                        <button class="delete-btn" data-id="${file.id}">üóëÔ∏è</button>
                    `;
                    surahList.appendChild(listItem);
                });
                contentDiv.appendChild(surahList);
            });
            listContainer.appendChild(reciterDiv);
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                deleteFile(id);
            });
        });
    }

    async function deleteFile(id) {
        if (!confirm('Delete this audio file? This is irreversible.')) return;

        // 1. Delete from IndexedDB
        await deleteFileFromDB(id);

        // 2. Delete from in-memory library
        const fileToDelete = appState.library.files.find(f => f.id === id);
        if (fileToDelete) {
            // Revoke URL to free memory
            URL.revokeObjectURL(fileToDelete.url);

            // Filter out of library.files
            appState.library.files = appState.library.files.filter(f => f.id !== id);

            // Filter out of reciters/surahs collections
            if (appState.library.reciters[fileToDelete.reciter]) {
                appState.library.reciters[fileToDelete.reciter] = appState.library.reciters[fileToDelete.reciter].filter(f => f.id !== id);
                if (appState.library.reciters[fileToDelete.reciter].length === 0) {
                    delete appState.library.reciters[fileToDelete.reciter];
                }
            }
            if (appState.library.surahs[fileToDelete.surah]) {
                appState.library.surahs[fileToDelete.surah] = appState.library.surahs[fileToDelete.surah].filter(f => f.id !== id);
                if (appState.library.surahs[fileToDelete.surah].length === 0) {
                    delete appState.library.surahs[fileToDelete.surah];
                }
            }

            // Filter out of current playlist
            appState.playlist.files = appState.playlist.files.filter(f => f.id !== id);

            // Stop playback if the current file was deleted
            if (appState.playback.audio.src.includes(fileToDelete.id)) {
                stopPlayback();
            }

            // Update UI
            updateRecitersDropdown();
            updateSurahsDropdown();
            updateRecitersList();
            updatePlaylistCount();
            updatePlaylistDisplay();
        }
    }

    // Playlist Creation Logic
    function updateRecitersDropdown() {
        const select = elements.reciterSelect;
        const currentReciter = select.value;
        select.innerHTML = '<option value="">All Reciters</option>';
        Object.keys(appState.library.reciters).sort().forEach(reciter => {
            const option = document.createElement('option');
            option.value = reciter;
            option.textContent = reciter;
            select.appendChild(option);
        });
        select.value = currentReciter || '';
        if (!select.value) updateSurahsDropdown();
    }

    function updateSurahsDropdown() {
        const reciterName = elements.reciterSelect.value;
        const select = elements.surahSelect;
        const currentSurah = select.value;
        select.innerHTML = '<option value="">All Surahs</option>';

        let files = [];
        if (reciterName) {
            files = appState.library.reciters[reciterName] || [];
        } else {
            files = appState.library.files;
        }

        const uniqueSurahs = [...new Set(files.map(f => f.surah))].sort();

        uniqueSurahs.forEach(surah => {
            const option = document.createElement('option');
            option.value = surah;
            option.textContent = surah;
            select.appendChild(option);
        });
        select.value = currentSurah || '';
    }

    elements.reciterSelect.addEventListener('change', updateSurahsDropdown);

    elements.createPlaylistButton.addEventListener('click', () => {
        const reciter = elements.reciterSelect.value;
        const surah = elements.surahSelect.value;
        const start = parseInt(elements.startVerseInput.value, 10);
        const end = parseInt(elements.endVerseInput.value, 10);
        const playlistRepeats = parseInt(elements.playlistRepeatsInput.value, 10) || 1;
        const verseRepeats = parseInt(elements.verseRepeatsInput.value, 10) || 1;

        if (isNaN(start) || isNaN(end) || start < 1 || end < 1 || start > end) {
            alert('Please enter a valid verse range (Start Verse must be less than or equal to End Verse).');
            return;
        }

        let filteredFiles = appState.library.files.slice();

        if (reciter) {
            filteredFiles = filteredFiles.filter(f => f.reciter === reciter);
        }
        if (surah) {
            filteredFiles = filteredFiles.filter(f => f.surah === surah);
        }

        const playlist = filteredFiles
            .filter(f => f.verse >= start && f.verse <= end && f.verse !== 0)
            .sort((a, b) => a.verse - b.verse);

        if (playlist.length === 0) {
            alert('No audio files found for the selected criteria and verse range.');
            return;
        }

        appState.playlist.files = playlist;
        appState.playlist.currentIndex = 0;
        appState.playlist.playlistRepeatCount = 0;
        appState.playlist.totalRepeats = playlistRepeats;
        appState.playback.totalVerseRepeats = verseRepeats;
        appState.playback.currentVerseRepeat = 0;

        updatePlaylistCount();
        updatePlaylistDisplay();

        // Start playback automatically
        playTrack(appState.playlist.currentIndex);
        elements.tabs[1].click(); // Switch to the Player tab
    });

    // Player and Controls Logic
    function updatePlaylistDisplay() {
        const container = elements.playlistFilesContainer;
        container.innerHTML = '';

        if (appState.playlist.files.length === 0) {
            container.innerHTML = '<li style="padding: 10px; font-size: 12px; color: #9ca3af; text-align: center;">Playlist is empty. Create a playlist above.</li>';
            return;
        }

        appState.playlist.files.forEach((file, index) => {
            const listItem = document.createElement('li');
            listItem.className = `file-item ${index === appState.playlist.currentIndex ? 'active' : ''}`;
            listItem.dataset.index = index;
            listItem.innerHTML = `
                <span class="file-index">${index + 1}.</span>
                <div class="file-main">
                    <span class="file-title">${file.surah} - Verse ${file.verse}</span>
                    <span class="file-meta">${file.reciter} / ${file.name}</span>
                </div>
                <button class="delete-btn" data-id="${file.id}">üóëÔ∏è</button>
            `;
            listItem.addEventListener('click', (e) => {
                // Ignore click if target is the delete button
                if (e.target.classList.contains('delete-btn')) return;
                playTrack(index);
            });
            container.appendChild(listItem);
        });

        // Re-attach listeners for delete buttons (though they are disabled for the playlist in the UI)
        container.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                // Note: Deleting a track from the playlist this way modifies the list live
                const indexToDelete = appState.playlist.files.findIndex(f => f.id === id);
                if (indexToDelete !== -1) {
                    appState.playlist.files.splice(indexToDelete, 1);
                    if (appState.playlist.currentIndex >= appState.playlist.files.length) {
                        appState.playlist.currentIndex = Math.max(0, appState.playlist.files.length - 1);
                    }
                    if (appState.playlist.files.length === 0) {
                        stopPlayback();
                    } else {
                        updatePlaylistDisplay();
                        if (appState.playback.isPlaying) {
                            playTrack(appState.playlist.currentIndex);
                        }
                    }
                }
            });
        });

        const currentFile = appState.playlist.files[appState.playlist.currentIndex];
        if (currentFile) {
            elements.nowPlayingTitle.textContent = `${currentFile.surah}: Verse ${currentFile.verse}`;
            elements.playbackInfo.textContent = `${currentFile.reciter} | Repeat ${appState.playback.currentVerseRepeat + 1} of ${appState.playback.totalVerseRepeats}`;
            if ('mediaSession' in navigator) {
                // Update Media Session Metadata
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: `${currentFile.surah}: Verse ${currentFile.verse}`,
                    artist: currentFile.reciter,
                    album: 'Quranic Recitation Player'
                });
            }
        } else {
            elements.nowPlayingTitle.textContent = 'No track selected';
            elements.playbackInfo.textContent = '‚Äî';
            elements.progressBar.style.width = '0%';
        }
    }

    function playTrack(index) {
        if (appState.playlist.files.length === 0) return;

        // Ensure index is valid
        if (index < 0 || index >= appState.playlist.files.length) {
            if (appState.playlist.playlistRepeatCount < appState.playlist.totalRepeats - 1) {
                appState.playlist.playlistRepeatCount++;
                appState.playlist.currentIndex = 0; // Wrap around to start
                playTrack(0);
                return;
            } else {
                stopPlayback();
                return;
            }
        }

        const file = appState.playlist.files[index];
        appState.playlist.currentIndex = index;
        appState.playback.audio.src = file.url;
        appState.playback.audio.load(); // Ensure the audio element is ready

        appState.playback.audio.play().then(() => {
            appState.playback.isPlaying = true;
            elements.playButton.innerHTML = '‚è∏'; // Pause icon
            elements.stopButton.disabled = false;
        }).catch(error => {
            console.error('Playback failed:', error);
            // This often happens if play() is not triggered by user action, but here it's usually fine after the first click.
            alert('Playback failed. Please ensure the player is in the active tab and try again.');
        });

        appState.playback.currentVerseRepeat = 0;
        updatePlaylistDisplay();
    }

    function playNextTrack() {
        appState.playback.currentVerseRepeat = 0; // Reset repeat counter for next verse
        playTrack(appState.playlist.currentIndex + 1);
    }

    function playPrevTrack() {
        // If current time is past 3 seconds, just restart the current track
        if (appState.playback.audio.currentTime > 3) {
            appState.playback.audio.currentTime = 0;
            appState.playback.audio.play();
            appState.playback.currentVerseRepeat = 0; // Restart verse repeat
            updatePlaylistDisplay();
            return;
        }
        // Otherwise, go to the previous track
        appState.playback.currentVerseRepeat = 0; // Reset repeat counter for next verse
        playTrack(appState.playlist.currentIndex - 1);
    }

    function playPauseToggle() {
        if (appState.playlist.files.length === 0) return;

        if (appState.playback.isPlaying) {
            appState.playback.audio.pause();
            elements.playButton.innerHTML = '‚ñ∂'; // Play icon
            appState.playback.isPlaying = false;
        } else {
            // If src is empty (first play), load the first track
            if (!appState.playback.audio.src) {
                playTrack(appState.playlist.currentIndex);
            } else {
                appState.playback.audio.play().then(() => {
                    elements.playButton.innerHTML = '‚è∏'; // Pause icon
                    appState.playback.isPlaying = true;
                    elements.stopButton.disabled = false;
                }).catch(error => {
                    console.error('Attempt to play failed:', error);
                    alert('Could not start playback. Please ensure the player is active.');
                });
            }
        }
    }

    function stopPlayback() {
        appState.playback.audio.pause();
        appState.playback.audio.currentTime = 0;
        appState.playback.isPlaying = false;
        elements.playButton.innerHTML = '‚ñ∂';
        elements.stopButton.disabled = true;
        elements.progressBar.style.width = '0%';
        appState.playback.currentVerseRepeat = 0;
        appState.playlist.playlistRepeatCount = 0;
        updatePlaylistDisplay();
    }

    elements.playButton.addEventListener('click', playPauseToggle);
    elements.prevButton.addEventListener('click', playPrevTrack);
    elements.nextButton.addEventListener('click', playNextTrack);
    elements.stopButton.addEventListener('click', stopPlayback);
    elements.clearPlaylistButton.addEventListener('click', () => {
        appState.playlist.files = [];
        stopPlayback();
        updatePlaylistCount();
        updatePlaylistDisplay();
    });

    // Time and Progress Bar Updates
    appState.playback.audio.addEventListener('timeupdate', () => {
        const audio = appState.playback.audio;
        if (audio.duration) {
            const progress = (audio.currentTime / audio.duration) * 100;
            elements.progressBar.style.width = progress + '%';

            const currentTimeText = formatTime(audio.currentTime);
            const durationText = formatTime(audio.duration);

            // Only update display if playing to avoid stuttering if this was used for playbackInfo
            // elements.playbackInfo.textContent = `${currentTimeText} / ${durationText}`;
        }
    });

    // Auto-advance/Repeat Logic
    appState.playback.audio.addEventListener('ended', () => {
        // Check for verse repeats first
        if (appState.playback.currentVerseRepeat < appState.playback.totalVerseRepeats - 1) {
            appState.playback.currentVerseRepeat++;
            // Restart the current track
            appState.playback.audio.currentTime = 0;
            appState.playback.audio.play().catch(e => console.error("Replay error:", e));
            updatePlaylistDisplay(); // Update repeat counter display
            return;
        }

        // If verse repeats are done, move to the next track
        appState.playback.currentVerseRepeat = 0;
        const nextIndex = appState.playlist.currentIndex + 1;

        if (nextIndex < appState.playlist.files.length) {
            playTrack(nextIndex);
        } else if (appState.playlist.playlistRepeatCount < appState.playlist.totalRepeats - 1) {
            // If end of playlist, check for playlist repeats
            appState.playlist.playlistRepeatCount++;
            playTrack(0); // Restart playlist
        } else {
            // End of all playback and repeats
            stopPlayback();
            appState.playlist.currentIndex = 0;
            updatePlaylistDisplay();
        }
    });

    // --- NEW FUNCTION TO ADD FOR iOS CONTROL CENTER SKIP/REWIND ---
    function setupMediaSessionHandlers() {
        if ('mediaSession' in navigator) {
            const audio = appState.playback.audio;

            // Set up the rewind action (seek backward)
            navigator.mediaSession.setActionHandler('seekbackward', (details) => {
                const seekTime = details.seekOffset || 10; // Default to 10 seconds rewind
                audio.currentTime = Math.max(0, audio.currentTime - seekTime);
                // No need to update the display here, timeupdate event will handle it
            });

            // Set up the skip action (seek forward)
            navigator.mediaSession.setActionHandler('seekforward', (details) => {
                const seekTime = details.seekOffset || 10; // Default to 10 seconds skip
                audio.currentTime = Math.min(audio.duration, audio.currentTime + seekTime);
                // No need to update the display here, timeupdate event will handle it
            });

            // Map native controls to your existing playback functions
            navigator.mediaSession.setActionHandler('play', playPauseToggle);
            navigator.mediaSession.setActionHandler('pause', playPauseToggle);
            navigator.mediaSession.setActionHandler('previoustrack', playPrevTrack);
            navigator.mediaSession.setActionHandler('nexttrack', playNextTrack);
            navigator.mediaSession.setActionHandler('stop', stopPlayback);
        }
    }
    // --- END NEW FUNCTION ---

    // PWA Install Banner Logic
    let deferredPrompt;

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        // Show banner after a delay or user interaction
        setTimeout(() => elements.installBanner.classList.add('show'), 2000);
    });

    elements.dismissBanner.addEventListener('click', () => {
        elements.installBanner.classList.remove('show');
    });

    // Initialization
    async function init() {
        await initDB();
        await loadLibraryFromDB();
        updatePlaylistCount();

        // --- IMPORTANT: Call the new function here to enable iOS skip/rewind ---
        setupMediaSessionHandlers();
    }

    init();
</script>
</body>
</html>